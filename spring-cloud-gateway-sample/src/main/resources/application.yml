# 测试 URI 配置（用于 RouteConfiguration.java）
sample-server:
  uri: http://localhost:8081

spring:
  jmx:
    enabled: false  # 禁用 JMX，避免与 Netty 冲突

  # Redis 配置（用于分布式限流）
  data:
    redis:
      host: 117.72.203.229
      port: 6379
      password: redis
      database: 0

  cloud:
    gateway.server.webflux:
      # 默认过滤器：应用于所有路由
      default-filters:
        - AddResponseHeader=X-Gateway, SpringCloudGateway  # 添加网关标识响应头

      routes:
        # 限流路由：所有以 /gateway/rate/ 开头的接口都应用限流
        - id: rate-limited
          order: 200
          predicates:
            - Path=/gateway/rate/test/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@smartKeyResolver}"
                redis-rate-limiter:
                  burst-capacity: 3
                  requested-tokens: 1
                  replenish-rate: 1
          uri: ${sample-server.uri}

        # 熔断器路由 - 当下游服务失败时返回降级响应
        - id: circuit-breaker-route
          predicates:
            - Path=/gateway/breaker/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: myCircuitBreaker
                fallbackUri: forward:/fallback
          uri: ${sample-server.uri}

# ============================================================================
# Resilience4J 熔断器配置
# ============================================================================
resilience4j:
  circuitbreaker:
    instances:
      myCircuitBreaker:
        sliding-window-size: 10           # 滑动窗口大小（最近10次请求）
        minimum-number-of-calls: 5        # 最少调用5次后才计算失败率
        failure-rate-threshold: 50       # 失败率达50%时熔断
        wait-duration-in-open-state: 10s  # 熔断10秒后尝试恢复
        permitted-number-of-calls-in-half-open-state: 3  # 半开状态允许3次测试请求
        sliding-window-type: count_based  # 基于计数（而非时间）


# ============================================================================
# 日志配置：开发环境使用 DEBUG/TRACE 级别
# ============================================================================
logging:
  level:
    org.springframework.cloud.gateway: TRACE     # 网关核心日志
    org.springframework.http.server.reactive: DEBUG  # HTTP 服务器日志
    org.springframework.web.reactive: DEBUG      # WebFlux 日志
    reactor.ipc.netty: DEBUG                     # 旧版 Netty 日志
    reactor.netty: DEBUG                         # Reactor Netty 日志
    # Resilience4J 熔断器日志
    io.github.resilience4j: DEBUG               # 熔断器核心日志
    io.github.resilience4j.circuitbreaker: TRACE  # 熔断器详细状态变化
    io.github.resilience4j.microprof: TRACE     # Micrometer 集成日志

# ============================================================================
# Actuator 管理端点配置
# 允许访问所有管理端点（生产环境应限制）
# ============================================================================
management.endpoints.web.exposure.include: '*'
